<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SQL Builder Dashboard</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
  <script src="viewmodel.js"></script>

  <style>
    body { padding-top: 1rem; }
    h2 { margin-top: 2rem; }
    .instruction-box {
      background: #f1f7ff;
      border-left: 4px solid #007bff;
      padding: .75rem;
      margin-bottom: 1rem;
    }
    .list-container {
      border: 1px solid #ccc;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      margin-top: .5rem;
      margin-bottom: 1rem;
      padding: 0;
      background: #fff;
    }
    .list-group-item-action { cursor: pointer; }
    .list-group-item.active { background-color: #007bff; color: #fff; }
    .mb-5 { margin-bottom: 3rem!important; }
    .mb-4 { margin-bottom: 1.5rem!important; }
    .mb-3 { margin-bottom: 1rem!important; }
    .mb-2 { margin-bottom: .5rem!important; }

    /* Docked Preview Styles */
    #dashboardPreviewDock {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 9999; background: #fff;
      border-top: 2px solid #007bff; box-shadow: 0 -2px 14px rgba(0,0,0,0.18);
      max-height: 50vh; overflow-y: auto; transition: max-height 0.3s;
    }
    #dashboardPreviewDock.minimized { max-height: 36px; overflow: hidden; }
    #dashboardPreviewDock .dock-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 16px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;
      cursor: pointer; user-select: none;
    }
    #dashboardPreviewDock .dock-header strong { font-size: 1.15em; }
    #dashboardPreviewDock .dock-content { padding: 12px 16px; }
    #dashboardPreviewDock .min-btn {
      background: none; border: none; font-size: 1.4em; color: #555; outline: none; cursor: pointer;
    }

    /* Autocomplete suggestions */
    .autocomplete-menu {
      position: absolute; z-index: 10000; background: #fff; border: 1px solid #ddd; border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,.15); max-height: 240px; overflow-y: auto; min-width: 280px;
    }
    .autocomplete-item { padding: 6px 10px; cursor: pointer; }
    .autocomplete-item:hover, .autocomplete-item.active { background: #f5f9ff; }
    .pos-rel { position: relative; }
  </style>
</head>
<body class="container">

  <h1>SQL Builder Dashboard v2.0</h1>
  <div class="instruction-box mb-4">
    <b>Welcome!</b> This builder creates dynamic, self-maintaining dashboards for Softdocs Content.
    <ul class="mt-2">
      <li>Auto-discovers party/person/entity fields from your Document Types</li>
      <li>New: Full <b>Field Catalog</b> with search + click-to-add</li>
      <li>New: <b>Autopopulate</b> keyfields by typing an <i>ID</i> or <i>Name</i></li>
      <li>Works from Content metadata (not in-flight forms)</li>
    </ul>
  </div>

  <!-- STEP 1 -->
  <h2>Step 1: Name Your Softdocs Integration Source</h2>
  <div class="instruction-box">
    Use the exact Source name created in Softdocs (Central → Admin Settings → Sources).
  </div>
  <input id="integrationNameInput" class="form-control mb-3" placeholder="e.g. myDashboardIntegration">

  <!-- STEP 2 -->
  <h2>Step 2: Choose Content Areas</h2>
  <div class="instruction-box">
    Click "Load Areas" to fetch available Content Areas.
  </div>
  <button id="loadAreasBtn" class="btn btn-primary mb-3">Load Areas</button>
  <div class="row mb-5">
    <div class="col-md-6">
      <h5>Available Areas</h5>
      <div class="list-container"><ul id="availableAreas" class="list-group"></ul></div>
    </div>
    <div class="col-md-6">
      <h5>Selected Areas</h5>
      <div class="list-container"><ul id="selectedAreas" class="list-group"></ul></div>
    </div>
  </div>

  <!-- STEP 3 -->
  <h2>Step 3: Choose Document Types</h2>
  <div class="instruction-box">
    Select one or more Document Types for your dashboard.
  </div>
  <div class="row mb-5">
    <div class="col-md-6">
      <h5>Available Document Types</h5>
      <div class="list-container"><ul id="availableDocTypes" class="list-group"></ul></div>
    </div>
    <div class="col-md-6">
      <h5>Selected Document Types</h5>
      <div class="list-container"><ul id="selectedDocTypes" class="list-group"></ul></div>
    </div>
  </div>

  <!-- STEP 4 -->
  <h2>Step 4: Choose Person/Entity Fields</h2>
  <div class="instruction-box">
    Auto-discovered from your Document Types. Click any to include as columns.
  </div>
  <div class="list-container mb-3"><ul id="discoveredPartyFields" class="list-group"></ul></div>

  <!-- STEP 4b -->
  <h2>Step 4b: Add Additional Keyfields</h2>
  <div class="instruction-box">
    Type a <b>Field ID</b> or start typing a <b>Field Name</b>—we’ll autopopulate the rest.
  </div>
  <div class="row mb-5">
    <div class="col-md-5">
      <h5 class="mb-2">Add New Keyfield</h5>
      <div class="pos-rel mb-2">
        <input id="keyfieldIdInput" class="form-control" placeholder="Field ID (e.g. 15)">
      </div>
      <div class="pos-rel mb-2">
        <input id="keyfieldNameInput" class="form-control" placeholder="Field Name (type to search)">
        <div id="keyfieldNameSuggest" class="autocomplete-menu" style="display:none;"></div>
      </div>
      <select id="keyfieldTypeInput" class="form-control mb-2">
        <option value="" selected>Auto (from Softdocs)</option>
        <option value="text">Text</option>
        <option value="number">Number</option>
        <option value="date">Date</option>
        <option value="money">Money</option>
        <option value="decimal">Decimal</option>
        <option value="lookup">Lookup</option>
      </select>
      <button id="addKeyfieldBtn" class="btn btn-info mb-2">Add Keyfield</button>
      <small class="text-muted d-block">
        Autopopulate looks in the Field Catalog first; if needed it calls <code>fieldMetaIntegration</code>.
      </small>
    </div>
    <div class="col-md-7">
      <h5 class="mb-2">Selected Keyfields</h5>
      <div class="list-container"><ul id="selectedKeyfields" class="list-group"></ul></div>
    </div>
  </div>

  <!-- STEP 4c -->
  <h2>Step 4c: Browse & Search All Fields</h2>
  <div class="instruction-box">
    Load the full catalog, then filter with the search box. Click a field to add it.
  </div>
  <div class="mb-3">
    <button id="loadAllFieldsBtn" class="btn btn-outline-primary btn-sm">Load Field Catalog</button>
    <input id="fieldSearchInput" class="form-control mt-2" placeholder="Search by name, code, type, or ID...">
  </div>
  <div id="allFieldsNestedList" class="list-container"></div>

  <!-- STEP 5 -->
  <h2>Step 5: Define Completion/Exit Status</h2>
  <div class="instruction-box">
    Choose a field and value that mark a document as “complete”; such rows will be hidden.
  </div>
  <div class="row mb-5">
    <div class="col-md-4">
      <select id="exitStatusFieldSelect" class="form-control mb-2">
        <option disabled selected>Choose Field</option>
      </select>
      <input id="exitStatusValueInput" class="form-control mb-2" placeholder="Exit/Completion Value (e.g. Complete)">
    </div>
    <div class="col-md-8">
      <div class="alert alert-secondary mb-0">
        Any document where this field equals this value will be hidden from all swimlanes.
      </div>
    </div>
  </div>

  <!-- STEP 6 -->
  <h2>Step 6: Define Swimlanes</h2>
  <div class="instruction-box">
    Group your dashboard by status/type/field to make it easier to use.
  </div>
  <div class="row mb-5">
    <div class="col-md-4">
      <input id="swimlaneNameInput" class="form-control mb-2" placeholder="Swimlane Name">
      <select id="swimlaneDocTypesSelect" class="form-control mb-2" multiple size="6"></select>
      <select id="swimlaneFieldSelect" class="form-control mb-2">
        <option value="">(Optional) Field</option>
      </select>
      <input id="swimlaneValueInput" class="form-control mb-2" placeholder="(Optional) Value to match">
      <button id="addSwimlaneBtn" class="btn btn-info mb-2">Add Swimlane</button>
    </div>
    <div class="col-md-8">
      <h5>Defined Swimlanes</h5>
      <div class="list-container"><ul id="selectedSwimlanes" class="list-group"></ul></div>
    </div>
  </div>

  <!-- STEP 7 -->
  <h2>Step 7: Choose Columns</h2>
  <div class="instruction-box">
    Click to add/remove. Reorder later for convenience.
  </div>
  <div class="row mb-5">
    <div class="col-md-6">
      <h5>Available Columns</h5>
      <div class="list-container"><ul id="availableColumns" class="list-group"></ul></div>
    </div>
    <div class="col-md-6">
      <h5>Selected Columns</h5>
      <div class="list-container"><ul id="selectedColumns" class="list-group"></ul></div>
    </div>
  </div>

  <!-- STEP 8 -->
  <h2>Step 8: Filter by Document Date</h2>
  <div class="instruction-box">
    Optionally limit results by creation date—explicit start date or relative window.
  </div>
  <div class="row mb-5">
    <div class="col-md-6">
      <label for="startDateInput">Start Date (optional):</label>
      <input id="startDateInput" class="form-control mb-3" type="date">
    </div>
    <div class="col-md-6">
      <label for="dateRangeSelect">Or select a relative range:</label>
      <select id="dateRangeSelect" class="form-control mb-3">
        <option value="">-- None --</option>
        <option value="3">Last 3 months</option>
        <option value="6">Last 6 months</option>
        <option value="12">Last 12 months</option>
        <option value="24">Last 24 months</option>
      </select>
    </div>
  </div>

  <!-- STEP 9 -->
  <h2>Step 9: Build SQL</h2>
  <div class="instruction-box">
    Click “Build SQL” to generate your query for the Softdocs data source.
  </div>
  <button id="buildSqlBtn" class="btn btn-secondary mb-3">Build SQL</button>
  <pre id="sqlOutput" class="bg-light p-2 mb-4" style="min-height:4em"></pre>

  <!-- Docked preview -->
  <div id="dashboardPreviewDock">
    <div class="dock-header">
      <strong>Dashboard Preview</strong>
      <button class="min-btn" title="Minimize Preview">&#x2212;</button>
    </div>
    <div class="dock-content">
      <div id="dashboardPreviewSection"></div>
      <div class="loading" style="display:none;"></div>
    </div>
  </div>

</body>
</html>
